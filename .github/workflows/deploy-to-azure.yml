name: Deploy to Azure Container App

env:
  DOCKERHUB_USERNAME: hazemusama
  DOCKERHUB_REPO: api

on:

  workflow_call:
    inputs:
      image_tag:
        description: 'The tag needed to deploy'
        required: true
        type: string

jobs:
  azure:
    runs-on: ubuntu-latest

    steps:

      # 1. Log in to Azure using the Service Principal credentials
      - name: 'Login to Azure'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 2. Deploy the specific image to Azure Container App
      - name: 'Deploy to Azure Container App'
        uses: azure/container-apps-deploy-action@v1
        with:
          imageToDeploy: ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPO }}:${{ inputs.image_tag }}
          containerAppName: ${{ secrets.CONTAINER_APP_NAME }}
          resourceGroup: ${{ secrets.RESOURCE_GROUP }}
          registryUrl: docker.io
          registryUsername: ${{ secrets.DOCKERHUB_USERNAME }}
          registryPassword: ${{ secrets.DOCKERHUB_TOKEN }}
